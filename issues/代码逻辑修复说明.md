# attendance_system_opencv.py 代码逻辑修复说明

## 修复时间
2025-11-04

## 修复的问题

### 1. ✅ 添加依赖说明
**问题**: 缺少opencv-contrib-python安装说明
**修复**: 在文件头部添加详细的依赖安装说明
```python
依赖安装:
pip install opencv-contrib-python pandas pillow requests numpy
```

### 2. ✅ 初始化目录和文件
**问题**: faces目录和attendance.csv文件不存在时程序会报错
**修复**: 添加`initialize_directories()`方法
- 自动创建faces目录
- 自动创建attendance.csv文件（带表头）

### 3. ✅ 员工数据持久化
**问题**: 员工数据硬编码，重启后新增员工丢失
**修复**: 
- 添加`save_employees()`方法，保存到employees.json
- 改进`load_employees()`方法，从JSON文件加载
- 如果文件不存在，使用默认数据并保存

### 4. ✅ 考勤记录功能
**问题**: 识别到人脸后没有记录考勤
**修复**: 添加`record_attendance(emp_id, emp_name)`方法
- 记录员工ID、姓名、日期、时间、签到时间
- 追加到attendance.csv文件（适配现有CSV格式）
- 添加日志提示

### 5. ✅ 防重复打卡机制
**问题**: `last_recognition_time`字典定义但未使用
**修复**: 在`record_attendance()`中实现
- 检查距离上次打卡是否超过5分钟（300秒）
- 5分钟内不重复记录
- 更新最后识别时间

### 6. ✅ PhotoImage引用保持
**问题**: PhotoImage对象可能被垃圾回收导致显示异常
**修复**: 
- 添加`self.current_photo`实例变量
- 在`update_video_display()`中保持引用

### 7. ✅ 改进add_employee
**问题**: 添加员工后数据未持久化
**修复**: 在`save_employee()`中调用`self.save_employees()`

### 8. ✅ employee_labels初始化
**问题**: 可能在使用前未初始化
**修复**: 在`__init__`中初始化为空字典

## 核心改进

### 考勤记录流程
```
识别人脸 -> 检查置信度 -> 获取员工信息 -> 检查冷却期 -> 记录考勤 -> 更新时间
```

### 数据持久化
- **employees.json**: 员工基本信息
- **attendance.csv**: 考勤记录
- **face_model.yml**: 人脸识别模型
- **face_labels.pkl**: 标签映射

## 使用说明

### 1. 安装依赖
```bash
pip install opencv-contrib-python pandas pillow requests numpy
```

### 2. 运行程序
```bash
python attendance_system_opencv.py
```

### 3. 添加员工
- 点击"添加员工"按钮
- 填写姓名、ID、选择照片
- 保存后会自动持久化到employees.json

### 4. 训练模型
- 确保faces目录下有员工照片
- 点击"训练模型"按钮
- 等待训练完成

### 5. 考勤打卡
- 摄像头会自动识别人脸
- 识别成功后自动记录考勤
- 5分钟内不会重复记录

## 优化记录

### 优化1: CSV格式适配（2025-11-04）
**问题**: 新代码创建的CSV列名与现有文件不一致
**修复**:
- 修改`initialize_directories()`中的列名为：`["员工ID", "姓名", "日期", "时间", "签到时间"]`
- 修改`record_attendance()`中的数据格式匹配现有CSV
- 保留所有已有考勤记录

### 优化2: 改进添加员工对话框（2025-11-04）
**问题**: 添加员工对话框按钮不可见或不明显
**修复**:
- 增加对话框高度：200 → 280
- 改用Grid布局替代Pack布局，更清晰
- 添加"确认"和"取消"两个按钮
- 改进"浏览"按钮功能，添加文件类型过滤
- 添加padding使界面更美观

### 优化3: 添加摄像头控制按钮（2025-11-04）
**问题**: 界面黑屏，无法看到摄像头画面，缺少手动控制
**修复**:
- 添加"▶ 启动摄像头"按钮
- 添加"⏸ 停止摄像头"按钮
- 添加`stop_video()`方法
- 改进`start_video()`错误处理：
  - 尝试摄像头0和摄像头1
  - 添加详细的错误提示
  - 添加摄像头初始化等待时间
  - 设置摄像头分辨率为640x480
- 取消自动启动摄像头，改为手动启动
- 添加按钮状态管理（启动后禁用启动按钮，启用停止按钮）
- 停止时在画布显示提示文字

### 优化4: 改进人脸检测和训练（2025-11-04）
**问题**: 训练时提示"图片中未检测到人脸"
**修复**:
- 改进`train_face_model()`方法：
  - 使用多组参数尝试检测人脸（标准→宽松→最宽松）
  - 统一调整人脸ROI大小为200x200
  - 添加详细的成功/失败统计
  - 改进错误提示，说明可能原因和建议
- 创建`test_face_detection.py`工具：
  - 批量检测faces目录下的所有图片
  - 生成标记后的图片（*_detected.jpg）
  - 显示人脸位置、大小、占比信息
  - 提供照片质量建议

### 优化5: 改进实时人脸识别（2025-11-04）
**问题**: 摄像头有画面但无法识别人物
**修复**:
- 改进`video_loop()`方法：
  - 放宽人脸检测参数：从(1.3, 5)改为(1.1, 4)，与训练一致
  - 调整人脸ROI大小为200x200，与训练时一致
  - 放宽置信度阈值：从70改为80
  - 添加置信度分级显示（高/中/低）
  - 只有中高置信度才记录考勤（< 65）
  - 在画面上显示检测状态和模型状态
  - 显示详细的识别信息（姓名、置信度）
  - 改进错误处理，显示错误信息
- 创建`test_recognition.py`工具：
  - 测试训练好的模型识别效果
  - 显示每张照片的识别结果和置信度
  - 提供置信度评级和改进建议

### 优化6: 修复中文显示乱码（2025-11-04）
**问题**: 摄像头画面上的中文显示为"？？？？"
**修复**:
- 添加`init_chinese_font()`方法：
  - 自动检测并加载系统中文字体（微软雅黑/黑体/宋体）
  - 支持Windows/Mac/Linux多平台
  - 加载失败时使用默认字体并提示
- 添加`put_chinese_text()`方法：
  - 使用PIL在OpenCV图像上绘制中文
  - 支持自定义字体、颜色、位置
- 改进`video_loop()`中的文字显示：
  - 所有中文文字使用PIL绘制
  - 包括：检测状态、模型状态、姓名、置信度等

## 照片要求

为了确保人脸识别训练成功，员工照片需要满足以下要求：

### ✓ 推荐的照片特征
- **正面照片**：面部正对镜头，不要侧脸
- **光线充足**：避免逆光、阴影
- **清晰度高**：分辨率至少300x300像素
- **人脸占比**：人脸占图片30%以上
- **无遮挡**：不戴口罩、墨镜、帽子
- **表情自然**：正常表情，眼睛睁开

### ✗ 避免的情况
- 侧脸、低头、仰头
- 光线太暗或太亮
- 模糊、像素化
- 人脸太小
- 戴口罩、墨镜等遮挡物

### 检测工具
使用以下命令检测照片质量：
```bash
# 检测faces目录下所有照片
python test_face_detection.py

# 检测单张照片
python test_face_detection.py path/to/photo.jpg
```

## 优化7: API配置分离（2025-11-04）
**问题**: API密钥硬编码在代码中，上传GitHub会泄露
**修复**:
- 创建`config.py`存储敏感配置
- 创建`config.example.py`作为模板
- 修改`attendance_system_opencv.py`从config.py加载配置
- 创建`.gitignore`排除敏感文件
- 创建`setup_config.py`配置助手
- 更新README.md说明配置方法

## 注意事项
1. 必须安装opencv-contrib-python，不能用opencv-python
2. 员工照片命名格式：faces/姓名.jpg
3. 考勤记录保存在attendance.csv，可用Excel打开
4. 防重复打卡时间为5分钟，可在代码中调整
5. CSV格式：员工ID,姓名,日期,时间,签到时间
6. 训练前先用test_face_detection.py检测照片质量
7. **首次使用需配置API密钥**：复制config.example.py为config.py并填写

